<div nz-row  style="height: 100%;" >
    @if(bDetailsExpanded==true){ 
        @if(requestSubmitedSuccessfull==false){
            <div nz-col [nzSpan]="15" >      
                <div nz-row >
                    <div nz-col [nzSpan]="14">
                        @if(requestSubmitedSuccessfull==false){ 
                            <h3>{{'Plot Details' | translate }}</h3>
                            <div class="table-nearest-base">
                                    @for (capakey of extraCapakeys; track capakey) {
                                        
                                        <div nz-row class="table-nearest" style="width: 100%;" [ngStyle]="{'background-color': (bPreviewCapakey | async) ===capakey ? '#FADBDF':'white' }" >
                                            <div nz-col [nzSpan]="12"   class="nearest-capakey"  (click)="previewCapakey(capakey)"> 
                                                {{capakey}}
                                            </div>
                                            <div nz-col [nzSpan]="12" > 
                                                @if(arrCapakeys[capakey]==undefined && capakey!=mainCapakey){   
                                                    <button  nz-button nzDanger nzType="default" class="mp-button-extra" style="width: 90%;" (click)="AddToRequest(capakey)">
                                                    <i style="cursor: grabbing;" nz-icon nzType="plus" nzTheme="outline">    </i> 
                                                        {{'Add to request'|translate}}                                           
                                                    </button>
                                                }
                                                @if(arrCapakeys[capakey]!=undefined && capakey!=mainCapakey){   
                                                    <button  nz-button nzDanger nzType="default" class="mp-button-extra" style="width: 90%;" (click)="RemoveFromRequest(capakey)">
                                                    <i style="cursor: grabbing;" nz-icon nzType="minus-circle" nzTheme="outline">    </i> 
                                                        {{'Remove'|translate}} 
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    }
                            </div>                        
                        }
                    </div>
                    <div nz-col [nzSpan]="8" >
                        <b>{{'Plot'|translate}} :</b> {{bPreviewCapakey| async}} 
                        <app-displayparcel-map *ngIf="(bPreviewCapakey | async)!=''" [capakey]=" bPreviewCapakey| async"></app-displayparcel-map>
                    </div>
                </div>
                <div nz-row >
                    <div nz-col [nzSpan]="24">
                        <app-mobiscore *ngIf="(bPreviewCapakey| async)!=''" [capaKey]="bPreviewCapakey| async"></app-mobiscore>
                    </div>
                </div>
            </div>    
            <div nz-col [nzSpan]="1" class="headerdivider"><i class="divider-button" style="cursor: grabbing;" nz-icon nzType="right" nzTheme="outline" (click)="ShowhideDetails()">    </i> </div>
        }
    }
    <div nz-col [nzSpan]="bDetailsExpanded==true?7:24" style="max-width: 100%" >      
                @if(requestSubmitedSuccessfull==false){ 
                    <h3>{{'KLIM Request' | translate }}
                        <span class="badge badge-light text-dark">{{oRequestsAcces?.totalRequests}}/{{oRequestsAcces?.totalRequestsAccess}}</span>
                    </h3>
                    <p class="text-drawer-header">{{'Fill in the details below to submit a request. Fields with * are required. Once submitted, you can track your request in the table on this page.' | translate}}</p>
                    <nz-tabset [nzSelectedIndex]="searchType" [ngClass]="totalCreditUsed===true?'fade-backround':''">
                        <nz-tab nzTitle="Capakey">
                            <div *ngTemplateOutlet="klimDetails"></div>
                            <label>{{'Parcel details'|translate}}</label>
                            <nz-divider style="margin: 4px 0; margin-bottom: 25px;"  nzPlain nzOrientation="left"></nz-divider>

                            <app-capakey-basic [bKlim]="bKlim"  (oCapaBasic)="selectionChange($event)" [capaKey]="capakeyReq" [tableRowData]="tableRowData"></app-capakey-basic>
                        </nz-tab>
                        <nz-tab [nzTitle]="'Address' | translate">
                            <div *ngTemplateOutlet="klimDetails"></div>
                            <label>{{'Parcel details'|translate}}</label>
                            <nz-divider style="margin: 4px 0; margin-bottom: 25px;" nzPlain  nzOrientation="left"></nz-divider>

                            <app-capa-adress [bKlim]="bKlim"  (oCapaBasic)="selectionChange($event)" [addressReq]="addressReq" [tableRowData]="tableRowData"></app-capa-adress>
                        </nz-tab>
                    </nz-tabset>
                    @if(totalCreditUsed==true){ 
                        <img nz-image width="337px" height="291px" style="position: absolute; top:250px" nzSrc="../../../../assets/img/icons/svg/upgradeplan.svg" alt=""/>
                        <p class="text-credits"> {{'Youâ€™ve reached the limit of requests for your current plan. Upgrade now to get more!'|translate}}</p>
                    }
                }
                @if(requestSubmitedSuccessfull==true){ 
                    <h3>{{'Request Submitted Successfully' | translate }}</h3>
                    <p>{{'Your request has been submitted and is now being processed. View and track the status of it in the table on this page.'|translate}}</p>
                }
                
                @if(requestSubmitedSuccessfull==true){ 
                    <img nz-image width="435px" height="611px" style="position: absolute; top:250px;padding:25px" nzSrc="../../../../assets/img/icons/svg/Illustration.svg" alt=""/>
                    
                }
                <div nz-row class="ant-drawer-footer modal-right-footer" >
                    <div nz-col [nzSpan]="12">
                        @if(requestSubmitedSuccessfull==false){ 
                            <button nz-button  nzPlacement="bottomRight" class="mp-button-light" (click)="ShowhideDetails()">
                                {{'More information'|translate}}
                            </button>
                        }@else if(requestSubmitedSuccessfull==true){ 
                            <button nz-button  nzPlacement="bottomRight" class="mp-button-light" (click)="restRequest()">
                                {{'Create Request'|translate}}
                            </button>
                        }
                    </div>
                    <div nz-col [nzSpan]="12" >
                        @if(requestSubmitedSuccessfull==false){ 
                        <button nz-button nzType="primary" nzDanger class="mp-button-primary" style="width: 90%;" (click)="createRequest()">
                            {{'Submit'|translate}}
                        </button>
                        }@else if(requestSubmitedSuccessfull==true){ 
                            <button nz-button nzType="primary" nzDanger class="mp-button-primary" style="width: 90%;" (click)="closeDrawer()">
                                {{'Complete'|translate}}
                            </button>
                        }

                        <!-- @if(allertMessage.message){ 
                            <nz-alert  [nzType]="allertMessage.type" [nzMessage]="allertMessage.message" nzShowIcon></nz-alert>
                        } -->
                    </div>
                </div>       
    </div>
</div>

<ng-template #klimDetails [formGroup]="form">
    <div nz-row>
        <div nz-col [nzSpan]="24" style="max-width: 100%" >  
            <mat-form-field class="matblock" appearance="outline">
                <mat-label>{{'Work Description' | translate}} </mat-label>
                <input type="text" placeholder="{{'Work Description'| translate}}" matInput formControlName="work_description" autocomplete="off">
                <div *ngIf="submitted && f['work_description'].errors" class="invalid-feedback">
                  <div *ngIf="f['work_description'].errors['required']">{{'Work Description' | translate}} {{'is required' | translate}}</div>
                </div>        
            </mat-form-field>
        </div>
    </div>
    <div nz-row>
        <div nz-col [nzSpan]="24" style="max-width: 100%" >  
            <mat-form-field appearance="outline">
                <mat-label>{{'Actor type' | translate}}</mat-label>
                <mat-select disableRipple formControlName="actorType_id" >
                  <!-- <mat-option value="0"></mat-option> -->
                  <mat-option *ngFor="let melding of this.arrCombos['ACTORTYPE']" [value]="melding.Id">{{melding.languageValue}}
                  </mat-option>
                </mat-select>
                <div *ngIf="submitted && f['actorType_id'].errors" class="invalid-feedback">
                  <div *ngIf="f['actorType_id'].errors['required']">{{'Actor type' | translate}} {{'is required' | translate}}
                  </div>
                </div>
              </mat-form-field>
        </div>
    </div>
    <div nz-row>
        <div nz-col [nzSpan]="24" style="max-width: 100%" >  
            <mat-form-field appearance="outline">
                <mat-label >{{'Notification type' | translate}} </mat-label>
                <mat-select disableRipple formControlName="typeMelding_id" (selectionChange)="onMeldingChange($event)">
                  <!-- <mat-option value="0"></mat-option> -->
                  <mat-option *ngFor="let melding of this.arrCombos['REQTYPE']" [value]="melding.Id">{{melding.languageValue}}
                  </mat-option>
                </mat-select>
                <div *ngIf="submitted && f['typeMelding_id'].errors" class="invalid-feedback">
                  <div *ngIf="f['typeMelding_id'].errors['required']">{{'Type Notification' | translate}} {{'is required' | translate}}
                  </div>
                </div>
              </mat-form-field>
        </div>
    </div>
    <div nz-row>
        <div nz-col [nzSpan]="24" style="max-width: 100%" >  
            <mat-form-field appearance="outline">
                <mat-label>{{'Work type' | translate}} </mat-label>
                <mat-select disableRipple formControlName="workType_id" (selectionChange)="onMeldingChange($event)">
                  <!--<mat-option value="0">{{'Select an option'| translate}}</mat-option> -->
                  <mat-option *ngFor="let melding of this.arrCombos['WORKTYPE']" [value]="melding.Id">{{melding.languageValue}}
                  </mat-option>
                </mat-select>
                <div *ngIf="submitted && f['workType_id'].errors" class="invalid-feedback">
                  <div *ngIf="f['workType_id'].errors['required']">{{'Work type' | translate}} {{'is required' | translate}}
                  </div>
                </div>
              </mat-form-field>
        </div>
    </div>

    <div nz-row>
        <div nz-col [nzSpan]="24" style="max-width: 100%" >  
            <mat-form-field appearance="outline">
                <mat-label>{{'Methode' | translate}} </mat-label>
                <mat-select disableRipple formControlName="execMethode_id" (selectionChange)="onMethodeChange($event)">
                  <!--<mat-option value="0">{{'Select an option'| translate}}</mat-option>-->
                  <mat-option *ngFor="let melding of this.arrCombos['EXEMETHOD']" [value]="melding.Id">{{melding.languageValue}}
                  </mat-option>
                </mat-select>
                <div *ngIf="submitted && f['execMethode_id'].errors" class="invalid-feedback">
                  <div *ngIf="f['execMethode_id'].errors['required']">{{'Methode' | translate}} {{'is required' | translate}}
                  </div>
                </div>
              </mat-form-field>
        </div>
    </div>

    <div nz-row>
        <div nz-col [nzSpan]="11">  
            <mat-form-field appearance="outline">
                <mat-label>{{'Start date'| translate}}</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="startDate" (dateChange)="datumChanged($event)" autocomplete="off">
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker ></mat-datepicker>
                <div *ngIf="submitted && f['startDate'].errors" class="invalid-feedback">
                  <div *ngIf="f['startDate'].errors['required']">{{'Start date' | translate}} {{'is required' | translate}}
                  </div>
                </div>
              </mat-form-field>
        </div>
        <div nz-col [nzSpan]="2" >  </div>
        <div nz-col [nzSpan]="11" >  
            <mat-form-field appearance="outline">
                <mat-label>{{'End date'| translate}}</mat-label>
                <input matInput [matDatepicker]="picker1"  formControlName="endDate" (dateChange)="datumChanged($event)" autocomplete="off">
                <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
                <mat-datepicker #picker1></mat-datepicker>
      
                <div *ngIf="f['endDate'].errors" class="invalid-feedback">
                  <div *ngIf="f['endDate'].errors['required']">{{'End date' | translate}} {{'is required' | translate}}
                  </div>
                </div>      
              </mat-form-field>
        </div>
    </div>

</ng-template>
